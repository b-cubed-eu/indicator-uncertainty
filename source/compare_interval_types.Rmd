---
title: "Interval type comparison"
author: "Ward Langeraert"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: show
    toc: true
    toc_float: true
    toc_collapsed: true
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../output/reports") })
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, warning=FALSE, message=FALSE}
# Load packages
library(b3gbi)       # Biodiversity indicators for data cubes
library(tidyverse)   # Data wrangling and visualisation
library(here)        # Relative paths
library(knitr)       # Nice tables

# Source functions
source(here("source", "R", "bootstrap_cube.R"))
source(here("source", "R", "get_bootstrap_ci.R"))
source(here("source", "R", "utils.R"))

# Cache folder
cache_path <- here("data", "cache")
dir.create(cache_path, showWarnings = FALSE, recursive = TRUE)
out_path <- here("output", "figures")
dir.create(out_path, showWarnings = FALSE, recursive = TRUE)
```

# Goal

Compare confidence interval types for different indicators.

# Data

We install b3gbi package version 0.2.2.

## Dataset

We load a dataset from the package.
How does the cube look like?

```{r}
# Load GBIF data cube
cube_name <- system.file("extdata", "europe_insect_cube.csv", package = "b3gbi")

# Load taxonomic info for cube
tax_info <- system.file("extdata", "europe_insect_info.csv", package = "b3gbi")

insect_data_df <- read.csv(cube_name)
head(insect_data_df)
```

We process the cube.

```{r}
# Prepare cube
insect_data <- process_cube_old(cube_name, tax_info, first_year = 2011,
                                last_year = 2020)

insect_data
```

## Indicators

We choose 3 indicators for comparison:

1.  Pielou's Evenness (`obs_richness_ts()`): real between 0-1
2.  Observed Species Richness (`obs_richness_ts()`): positive integer
3.  Mean Number of Observations: real (normal)

**1. Pielou's Evenness**

Let's calculate Pielou's Evenness over time.

```{r}
evenness_insect_data <- obs_richness_ts(insect_data)
evenness_insect_data$data %>%
  kable(digits = 3)
```

```{r}
plot(evenness_insect_data)
```

**2. Observed Species Richness**

Let's calculate the Observed Species Richness over time.

```{r}
richness_insect_data <- obs_richness_ts(insect_data)
richness_insect_data$data %>%
  kable()
```

```{r}
plot(richness_insect_data)
```

**3. Mean Number of Observations**

```{r}
# Define function for calculating statistic
mean_obs <- function(data) {
  aggregate(data$obs,
            by = list(year = data$year),
            FUN = mean) |>
    dplyr::rename("diversity_val" = "x")
}
```

Let's calculate the Mean Number of Observations over time.

```{r}
mean_obs_insect_data <- mean_obs(insect_data$data)
mean_obs_insect_data %>%
  kable(digits = 3)
```

```{r}
mean_obs_insect_data %>%
  ggplot(aes(x = year, y = diversity_val)) +
    geom_smooth(method = "loess", formula = "y ~ x", se = TRUE,
                colour = alpha("cornflowerblue", 0.8),
                fill = alpha("cornflowerblue", 0.1), linetype = "dashed") +
    geom_line(colour = "orange", linewidth = 1) +
    theme_minimal() +
    labs(x = "Year", y = "Mean Number of Observations")
```

# Bootstrapping and interval calculation
## Pielou's Evenness

Bootstrapping:

```{r, echo=FALSE, message=FALSE}
# Bootstrapping
insect_evenness_path <- file.path(cache_path, "bootstrap_insect_data.Rds")
if (file.exists(insect_evenness_path)) {
  bootstrap_insect_evenness <- readRDS(insect_evenness_path)
} else {
  bootstrap_insect_evenness <- bootstrap_cube(
    data_cube = insect_data,
    fun = b3gbi::obs_richness_ts,
    grouping_var = "year",
    samples = 1000,
    seed = 123,
    progress = TRUE)
  saveRDS(bootstrap_insect_evenness, insect_evenness_path)
}
```

```r
bootstrap_insect_evenness <- bootstrap_cube(
  data_cube = insect_data,
  fun = b3gbi::obs_richness_ts,
  grouping_var = "year",
  samples = 1000,
  seed = 123,
  progress = TRUE)
```

We visualise the distribution of the bootstrap replicates
The bootstrap bias is the difference between the estimate and the bootstrap estimate.

```{r, fig.width = 10, echo=FALSE, warning=FALSE}
bias_evenness <- bootstrap_insect_evenness %>%
  distinct(year, estimate = est_original, `bootstrap estimate` = est_boot)

estimate_evenness <- bias_evenness %>%
  pivot_longer(cols = c("estimate", "bootstrap estimate"),
               names_to = "Legend", values_to = "value") %>%
  mutate(Legend = factor(Legend, levels = c("estimate", "bootstrap estimate"),
                         ordered = TRUE))

bootstrap_insect_evenness %>%
  ggplot(aes(x = year)) +
    geom_violin(aes(y = rep_boot, group = year),
                fill = alpha("cornflowerblue", 0.2)) +
    geom_segment(data = bias_evenness,
                 aes(xend = year, y = estimate, yend = `bootstrap estimate`),
                 colour = "darkblue", linewidth = 0.8, linetype = "dashed") +
    geom_point(data = estimate_evenness, aes(y = value, shape = Legend),
               colour = "firebrick", size = 2) +
    labs(x = "", y = "Pielou's Evenness", shape = "Legend:") +
    scale_y_continuous(limits = c(0, 1), breaks = seq(-10, 10, 0.25)) +
    scale_x_continuous(breaks = sort(unique(bootstrap_insect_evenness$year))) +
    theme_minimal() +
    theme(legend.position = "bottom",
          legend.title = element_text(face = "bold"))
```

We calculate all types of intervals.

```{r, echo=FALSE, message=FALSE}
# Bootstrapping
ci_insect_evenness_path <- file.path(cache_path, "ci_df.Rds")
if (file.exists(ci_insect_evenness_path)) {
  ci_insect_evenness <- readRDS(ci_insect_evenness_path)
} else {
  # Calculate confidence intervals
  ci_insect_evenness <- get_bootstrap_ci(
    bootstrap_samples_df = bootstrap_insect_evenness,
    grouping_var = "year",
    type = c("perc", "bca", "norm", "basic"),
    conf = 0.95,
    aggregate = TRUE,
    data_cube = insect_data,
    fun = b3gbi::obs_richness_ts,
    progress = TRUE)
  saveRDS(ci_insect_evenness, ci_insect_evenness_path)
}
```

```r
ci_insect_evenness <- get_bootstrap_ci(
  bootstrap_samples_df = bootstrap_insect_evenness,
  grouping_var = "year",
  type = c("perc", "bca", "norm", "basic"),
  conf = 0.95,
  aggregate = TRUE,
  data_cube = insect_data,
  fun = b3gbi::obs_richness_ts,
  progress = TRUE)
```

## Observed Species Richness

Bootstrapping:

```{r, echo=FALSE, message=FALSE}
# Bootstrapping
insect_richness_path <- file.path(cache_path, "bootstrap_insect_richness.Rds")
if (file.exists(insect_richness_path)) {
  bootstrap_insect_richness <- readRDS(insect_richness_path)
} else {
  bootstrap_insect_richness <- bootstrap_cube(
    data_cube = insect_data,
    fun = b3gbi::obs_richness_ts,
    grouping_var = "year",
    samples = 1000,
    seed = 123,
    progress = TRUE)
  saveRDS(bootstrap_insect_richness, insect_richness_path)
}
```

```r
bootstrap_insect_richness <- bootstrap_cube(
  data_cube = insect_data,
  fun = b3gbi::obs_richness_ts,
  grouping_var = "year",
  samples = 1000,
  seed = 123,
  progress = TRUE)
```

We visualise the distribution of the bootstrap replicates
The bootstrap bias is the difference between the estimate and the bootstrap estimate.

```{r, fig.width = 10, echo=FALSE, warning=FALSE}
bias_richness <- bootstrap_insect_richness %>%
  distinct(year, estimate = est_original, `bootstrap estimate` = est_boot)

estimate_richness <- bias_richness %>%
  pivot_longer(cols = c("estimate", "bootstrap estimate"),
               names_to = "Legend", values_to = "value") %>%
  mutate(Legend = factor(Legend, levels = c("estimate", "bootstrap estimate"),
                         ordered = TRUE))

bootstrap_insect_richness %>%
  ggplot(aes(x = year)) +
    geom_violin(aes(y = rep_boot, group = year),
                fill = alpha("cornflowerblue", 0.2)) +
    geom_segment(data = bias_richness,
                 aes(xend = year, y = estimate, yend = `bootstrap estimate`),
                 colour = "darkblue", linewidth = 0.8, linetype = "dashed") +
    geom_point(data = estimate_richness, aes(y = value, shape = Legend),
               colour = "firebrick", size = 2) +
    labs(x = "", y = "Observed Species Richness", shape = "Legend:") +
    scale_y_continuous(limits = c(0, NA)) +
    scale_x_continuous(breaks = sort(unique(bootstrap_insect_richness$year))) +
    theme_minimal() +
    theme(legend.position = "bottom",
          legend.title = element_text(face = "bold"))
```

We calculate all types of intervals.

```{r, echo=FALSE, message=FALSE}
# Bootstrapping
ci_insect_richness_path <- file.path(cache_path, "ci_insect_richness.Rds")
if (file.exists(ci_insect_richness_path)) {
  ci_insect_richness <- readRDS(ci_insect_richness_path)
} else {
  # Calculate confidence intervals
  ci_insect_richness <- get_bootstrap_ci(
    bootstrap_samples_df = bootstrap_insect_richness,
    grouping_var = "year",
    type = c("perc", "bca", "norm", "basic"),
    conf = 0.95,
    aggregate = TRUE,
    data_cube = insect_data,
    fun = b3gbi::obs_richness_ts,
    progress = TRUE)
  saveRDS(ci_insect_richness, ci_insect_richness_path)
}
```

```r
ci_insect_richness <- get_bootstrap_ci(
  bootstrap_samples_df = bootstrap_insect_richness,
  grouping_var = "year",
  type = c("perc", "bca", "norm", "basic"),
  conf = 0.95,
  aggregate = TRUE,
  data_cube = insect_data,
  fun = b3gbi::obs_richness_ts,
  progress = TRUE)
```

## Mean Number of Observations

Bootstrapping:

```{r, echo=FALSE, message=FALSE}
# Bootstrapping
insect_mean_obs_path <- file.path(cache_path, "bootstrap_insect_mean_obs.Rds")
if (file.exists(insect_mean_obs_path)) {
  bootstrap_insect_mean_obs <- readRDS(insect_mean_obs_path)
} else {
  bootstrap_insect_mean_obs <- bootstrap_cube(
    data_cube = insect_data$data,
    fun = mean_obs,
    grouping_var = "year",
    samples = 1000,
    seed = 123,
    progress = TRUE)
  saveRDS(bootstrap_insect_mean_obs, insect_mean_obs_path)
}
```

```r
bootstrap_insect_mean_obs <- bootstrap_cube(
  data_cube = insect_data$data,
  fun = mean_obs,
  grouping_var = "year",
  samples = 1000,
  seed = 123,
  progress = TRUE)
```

We visualise the distribution of the bootstrap replicates
The bootstrap bias is the difference between the estimate and the bootstrap estimate.

```{r, fig.width = 10, echo=FALSE, warning=FALSE}
bias_mean_obs <- bootstrap_insect_mean_obs %>%
  distinct(year, estimate = est_original, `bootstrap estimate` = est_boot)

estimate_mean_obs <- bias_mean_obs %>%
  pivot_longer(cols = c("estimate", "bootstrap estimate"),
               names_to = "Legend", values_to = "value") %>%
  mutate(Legend = factor(Legend, levels = c("estimate", "bootstrap estimate"),
                         ordered = TRUE))

bootstrap_insect_mean_obs %>%
  ggplot(aes(x = year)) +
    geom_violin(aes(y = rep_boot, group = year),
                fill = alpha("cornflowerblue", 0.2)) +
    geom_segment(data = bias_mean_obs,
                 aes(xend = year, y = estimate, yend = `bootstrap estimate`),
                 colour = "darkblue", linewidth = 0.8, linetype = "dashed") +
    geom_point(data = estimate_mean_obs, aes(y = value, shape = Legend),
               colour = "firebrick", size = 2) +
    labs(x = "", y = "Mean Number of Observations", shape = "Legend:") +
    scale_y_continuous(limits = c(0, NA)) +
    scale_x_continuous(breaks = sort(unique(bootstrap_insect_mean_obs$year))) +
    theme_minimal() +
    theme(legend.position = "bottom",
        legend.title = element_text(face = "bold"))
```

We calculate all types of intervals.

```{r, echo=FALSE, message=FALSE}
# Bootstrapping
ci_insect_mean_obs_path <- file.path(cache_path, "ci_insect_mean_obs.Rds")
if (file.exists(ci_insect_mean_obs_path)) {
  ci_insect_mean_obs <- readRDS(ci_insect_mean_obs_path)
} else {
  # Calculate confidence intervals
  ci_insect_mean_obs <- get_bootstrap_ci(
    bootstrap_samples_df = bootstrap_insect_mean_obs,
    grouping_var = "year",
    type = c("perc", "bca", "norm", "basic"),
    conf = 0.95,
    aggregate = TRUE,
    data_cube = insect_data$data,
    fun = mean_obs,
    progress = TRUE)
  saveRDS(ci_insect_mean_obs, ci_insect_mean_obs_path)
}
```

```r
ci_insect_mean_obs <- get_bootstrap_ci(
  bootstrap_samples_df = bootstrap_insect_mean_obs,
  grouping_var = "year",
  type = c("perc", "bca", "norm", "basic"),
  conf = 0.95,
  aggregate = TRUE,
  data_cube = insect_data$data,
  fun = mean_obs,
  progress = TRUE)
```

# Analysis and visualisation

```{r}
ci_insect_evenness <- ci_insect_evenness %>%
  mutate(int_type = factor(int_type,
                           levels = c("norm", "basic", "perc", "bca")))
ci_insect_richness <- ci_insect_richness %>%
  mutate(int_type = factor(int_type,
                           levels = c("norm", "basic", "perc", "bca"))) %>%
  drop_na()
ci_insect_mean_obs <- ci_insect_mean_obs %>%
  mutate(int_type = factor(int_type,
                           levels = c("norm", "basic", "perc", "bca")))
```

We visualise the distribution of the bootstrap replicates and the confidence intervals.

```{r, fig.width = 10, echo=FALSE, warning=FALSE}
bootstrap_insect_evenness %>%
  ggplot(aes(x = year)) +
    geom_violin(aes(y = rep_boot, group = year),
                fill = alpha("cornflowerblue", 0.2)) +
    geom_point(data = estimate_evenness, aes(y = value, shape = Legend),
               colour = "firebrick", size = 2, alpha = 0.5) +
    geom_errorbar(data = ci_insect_evenness,
                  aes(ymin = ll, ymax = ul, colour = int_type),
                  position = position_dodge(0.8), linewidth = 1) +
    labs(y = "Pielou's Evenness", colour = "Interval type:", x = "",
         shape = "Legend:") +
    scale_y_continuous(limits = c(NA, 1), breaks = seq(-10, 10, 0.25)) +
    scale_x_continuous(breaks = sort(unique(bootstrap_insect_evenness$year))) +
    theme_minimal() +
    theme(legend.position = "bottom",
          legend.title = element_text(face = "bold"))
```

```{r, fig.width = 10, echo=FALSE, warning=FALSE}
bootstrap_insect_richness %>%
  ggplot(aes(x = year)) +
    geom_violin(aes(y = rep_boot, group = year),
                fill = alpha("cornflowerblue", 0.2)) +
    geom_point(data = estimate_richness, aes(y = value, shape = Legend),
               colour = "firebrick", size = 2, alpha = 0.5) +
    geom_errorbar(data = ci_insect_richness,
                  aes(ymin = ll, ymax = ul, colour = int_type),
                  position = position_dodge(0.8), linewidth = 1) +
    labs(y = "Observed Species Richness", colour = "Interval type:", x = "",
         shape = "Legend:") +
    scale_y_continuous(limits = c(0, NA)) +
    scale_x_continuous(breaks = sort(unique(bootstrap_insect_richness$year))) +
    theme_minimal() +
    theme(legend.position = "bottom",
          legend.title = element_text(face = "bold"))
```

```{r, fig.width = 10, echo=FALSE, warning=FALSE}
bootstrap_insect_mean_obs %>%
  ggplot(aes(x = year)) +
    geom_violin(aes(y = rep_boot, group = year),
                fill = alpha("cornflowerblue", 0.2)) +
    geom_point(data = estimate_mean_obs, aes(y = value, shape = Legend),
               colour = "firebrick", size = 2, alpha = 0.5) +
    geom_errorbar(data = ci_insect_mean_obs,
                  aes(ymin = ll, ymax = ul, colour = int_type),
                  position = position_dodge(0.8), linewidth = 1) +
    labs(y = "Mean Number of Observations", colour = "Interval type:", x = "",
         shape = "Legend:") +
    scale_y_continuous(limits = c(NA, NA)) +
    scale_x_continuous(breaks = sort(unique(bootstrap_insect_mean_obs$year))) +
    theme_minimal() +
    theme(legend.position = "bottom",
          legend.title = element_text(face = "bold"))
```

The interval width increases when the bootstrap standard error increases, as expected.

```{r}
ci_insect_evenness %>%
    mutate(indicator = "Pielou's Evenness") %>%
    bind_rows(
        ci_insect_richness %>%
            mutate(indicator = "Observed Species Richness"),
        ci_insect_mean_obs %>%
            mutate(indicator = "Mean Number of Observations")
    ) %>%
    mutate(ci_width = ul - ll,
           indicator = factor(indicator,
                              levels = c("Pielou's Evenness",
                                         "Observed Species Richness",
                                         "Mean Number of Observations"))
    ) %>%
    distinct(year, se_boot, indicator) %>%
    ggplot(aes(x = indicator, y = se_boot)) +
    geom_boxplot(fill = alpha("cornflowerblue", 0.2),
                 outlier.colour = "firebrick") +
    geom_jitter(size = 1.5, width = 0.2) +
    labs(y = "Bootstrap Standard Error", x = "") +
    facet_wrap(~indicator, ncol = 3, scales = "free") +
    theme_minimal()
```

```{r, echo=FALSE, warning=FALSE}
ci_insect_evenness %>%
  mutate(indicator = "Pielou's Evenness") %>%
  bind_rows(
    ci_insect_richness %>%
      mutate(indicator = "Observed Species Richness"),
    ci_insect_mean_obs %>%
      mutate(indicator = "Mean Number of Observations")
  ) %>%
  mutate(ci_width = ul - ll,
         indicator = factor(indicator,
                            levels = c("Pielou's Evenness",
                                       "Observed Species Richness",
                                       "Mean Number of Observations"))
  ) %>%
  distinct(year, se_boot, int_type, ci_width, indicator) %>%
  ggplot(aes(x = se_boot, y = ci_width, colour = int_type)) +
    geom_smooth(method = "lm", formula = "y ~ x") +
    geom_point(size = 1.5) +
    labs(x = "Bootstrap Standard Error", y = "Interval Width",
         colour = "Interval type") +
    facet_wrap(~indicator, ncol = 2, scales = "free") +
    theme_minimal() +
    theme(
      legend.title = element_text(face = "bold"),
      legend.position = c(1, 0),
      legend.justification = c(2, -0.25)
    )
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
ci_insect_evenness %>%
  mutate(indicator = "Pielou's Evenness") %>%
  bind_rows(
    ci_insect_richness %>%
      mutate(indicator = "Observed Species Richness"),
    ci_insect_mean_obs %>%
      mutate(indicator = "Mean Number of Observations")
  ) %>%
  mutate(ci_width = ul - ll,
         indicator = factor(indicator,
                            levels = c("Pielou's Evenness",
                                       "Observed Species Richness",
                                       "Mean Number of Observations"))
  ) %>%
  distinct(year, se_boot, int_type, ci_width, indicator) %>%
  group_by(int_type, indicator) %>%
  group_modify(~ grouped_regression(df = ., formula = ci_width ~ se_boot)) %>%
  ungroup() %>%
  filter(param == "se_boot") %>%
  arrange(int_type, indicator) %>%
  kable(digits = 5)
```

We see no relation to bias for evenness.
For species richness there is a negative relationship.

```{r}
ci_insect_evenness %>%
    mutate(indicator = "Pielou's Evenness") %>%
    bind_rows(
        ci_insect_richness %>%
            mutate(indicator = "Observed Species Richness"),
        ci_insect_mean_obs %>%
            mutate(indicator = "Mean Number of Observations")
    ) %>%
    mutate(ci_width = ul - ll,
           indicator = factor(indicator,
                              levels = c("Pielou's Evenness",
                                         "Observed Species Richness",
                                         "Mean Number of Observations"))
    ) %>%
    distinct(year, bias_boot, indicator) %>%
    ggplot(aes(x = indicator, y = bias_boot)) +
    geom_boxplot(fill = alpha("cornflowerblue", 0.2),
                 outlier.colour = "firebrick") +
    geom_jitter(size = 1.5, width = 0.2) +
    labs(y = "Bootstrap Bias", x = "") +
    facet_wrap(~indicator, ncol = 3, scales = "free") +
    theme_minimal()
```

```{r, echo=FALSE, warning=FALSE}
ci_insect_evenness %>%
  mutate(indicator = "Pielou's Evenness") %>%
  bind_rows(
    ci_insect_richness %>%
      mutate(indicator = "Observed Species Richness"),
    ci_insect_mean_obs %>%
      mutate(indicator = "Mean Number of Observations")
  ) %>%
  mutate(ci_width = ul - ll,
         indicator = factor(indicator,
                            levels = c("Pielou's Evenness",
                                       "Observed Species Richness",
                                       "Mean Number of Observations"))
  ) %>%
  distinct(year, bias_boot, int_type, ci_width, indicator) %>%
  ggplot(aes(x = bias_boot, y = ci_width, colour = int_type)) +
    geom_smooth(method = "lm", formula = "y ~ x") +
    geom_point(size = 1.5) +
    labs(x = "Bootstrap Bias", y = "Interval Width",
         colour = "Interval type") +
    facet_wrap(~indicator, ncol = 2, scales = "free") +
    theme_minimal() +
    theme(
      legend.title = element_text(face = "bold"),
      legend.position = c(1, 0),
      legend.justification = c(2, -0.25)
    )
```

```{r, echo=FALSE}
ci_insect_evenness %>%
  mutate(indicator = "Pielou's Evenness") %>%
  bind_rows(
    ci_insect_richness %>%
      mutate(indicator = "Observed Species Richness"),
    ci_insect_mean_obs %>%
      mutate(indicator = "Mean Number of Observations")
  ) %>%
  mutate(ci_width = ul - ll,
         indicator = factor(indicator,
                            levels = c("Pielou's Evenness",
                                       "Observed Species Richness",
                                       "Mean Number of Observations"))
  ) %>%
  distinct(year, bias_boot, int_type, ci_width, indicator) %>%
  group_by(int_type, indicator) %>%
  group_modify(~ grouped_regression(df = ., formula = ci_width ~ bias_boot)) %>%
  ungroup() %>%
  filter(param == "bias_boot") %>%
  arrange(int_type, indicator) %>%
  kable(digits = 5)
```

If we remove the outliers for mean number of observations, we do not see a trend there as well.

```{r, echo=FALSE, warning=FALSE}
ci_insect_evenness %>%
  mutate(indicator = "Pielou's Evenness") %>%
  bind_rows(
    ci_insect_richness %>%
      mutate(indicator = "Observed Species Richness"),
    ci_insect_mean_obs %>%
      mutate(indicator = "Mean Number of Observations")
  ) %>%
  mutate(ci_width = ul - ll,
         indicator = factor(indicator,
                            levels = c("Pielou's Evenness",
                                       "Observed Species Richness",
                                       "Mean Number of Observations"))
  ) %>%
  distinct(year, bias_boot, int_type, ci_width, indicator) %>%
  filter(!(indicator == "Mean Number of Observations" & bias_boot > 2)) %>%
  ggplot(aes(x = bias_boot, y = ci_width, colour = int_type)) +
    geom_smooth(method = "lm", formula = "y ~ x") +
    geom_point(size = 1.5) +
    labs(x = "Bootstrap Bias", y = "Interval Width",
         colour = "Interval type") +
    facet_wrap(~indicator, ncol = 2, scales = "free") +
    theme_minimal() +
    theme(
      legend.title = element_text(face = "bold"),
      legend.position = c(1, 0),
      legend.justification = c(2, -0.25)
    )
```

```{r, echo=FALSE}
ci_insect_evenness %>%
  mutate(indicator = "Pielou's Evenness") %>%
  bind_rows(
    ci_insect_richness %>%
      mutate(indicator = "Observed Species Richness"),
    ci_insect_mean_obs %>%
      mutate(indicator = "Mean Number of Observations")
  ) %>%
  mutate(ci_width = ul - ll,
         indicator = factor(indicator,
                            levels = c("Pielou's Evenness",
                                       "Observed Species Richness",
                                       "Mean Number of Observations"))
  ) %>%
  distinct(year, bias_boot, int_type, ci_width, indicator) %>%
  filter(!(indicator == "Mean Number of Observations" & bias_boot > 2)) %>%
  group_by(int_type, indicator) %>%
  group_modify(~ grouped_regression(df = ., formula = ci_width ~ bias_boot)) %>%
  ungroup() %>%
  filter(param == "bias_boot") %>%
  arrange(int_type, indicator) %>%
  kable(digits = 5)
```
