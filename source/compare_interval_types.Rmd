---
title: "Interval type comparison"
author: "Ward Langeraert"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: show
    toc: true
    toc_float: true
    toc_collapsed: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, warning=FALSE, message=FALSE}
# Load packages
library(b3gbi)       # Biodiversity indicators for data cubes
library(tidyverse)   # Data wrangling and visualisation
library(here)        # Relative paths
library(knitr)       # Nice tables

# Source functions
source(here("source", "R", "bootstrap_cube.R"))
source(here("source", "R", "get_bootstrap_ci.R"))
source(here("source", "R", "utils.R"))

# Cache folder
cache_path <- here("data", "cache")
dir.create(cache_path)
```

# Goal

Compare confidence interval types for different indicators.

# Data

We install b3gbi package version 0.2.2.

## Dataset

We load a dataset from the package.
How does the cube look like?

```{r}
# Load GBIF data cube
cube_name <- system.file("extdata", "europe_insect_cube.csv", package = "b3gbi")

# Load taxonomic info for cube
tax_info <- system.file("extdata", "europe_insect_info.csv", package = "b3gbi")

insect_data_df <- read.csv(cube_name)
head(insect_data_df)
```

We process the cube.

```{r}
# Prepare cube
insect_data <- process_cube_old(cube_name, tax_info, first_year = 2011,
                                last_year = 2020)

insect_data
```

## Indicators

We choose 3 indicators for comparison:

1.  Pielou's Evenness (`pielou_evenness_ts()`): real between 0-1
2.  Observed Species Richness (`obs_richness_ts()`): positive integer
3.  Mean Number of Observations: real (normal)

**1. Pielou's Eveness**

Let's calculate Pielou's Evenness over time.

```{r}
eveness_insect_data <- pielou_evenness_ts(insect_data)
eveness_insect_data$data %>%
  kable(digits = 3)
```

```{r}
plot(eveness_insect_data)
```

**2. Observed Species Richness**

Let's calculate the Observed Species Richness over time.

```{r}
richness_insect_data <- obs_richness_ts(insect_data)
richness_insect_data$data %>%
  kable()
```

```{r}
plot(richness_insect_data)
```

**3. Mean Number of Observations**

```{r}
# Define function for calculating statistic
mean_obs <- function(data) {
  aggregate(data$obs,
            by = list(year = data$year),
            FUN = mean) |>
    dplyr::rename("diversity_val" = "x")
}
```

Let's calculate the Mean Number of Observations over time.

```{r}
mean_obs_insect_data <- mean_obs(insect_data$data)
mean_obs_insect_data %>%
  kable(digits = 3)
```

```{r}
mean_obs_insect_data %>%
  ggplot(aes(x = year, y = diversity_val)) +
    geom_smooth(method = "loess", formula = "y ~ x", se = TRUE,
                colour = alpha("cornflowerblue", 0.8),
                fill = alpha("cornflowerblue", 0.1), linetype = "dashed") +
    geom_line(colour = "orange", linewidth = 1) +
    theme_minimal() +
    labs(x = "Year", y = "Mean Number of Observations")
```

# Bootstrapping and interval calculation
## Pielou's Eveness

Bootstrapping

```{r, echo=FALSE, message=FALSE}
# Bootstrapping
insect_evenness_path <- file.path(cache_path, "bootstrap_insect_data.Rds")
if (file.exists(insect_evenness_path)) {
  bootstrap_insect_evenness <- readRDS(insect_evenness_path)
} else {
  bootstrap_insect_evenness <- bootstrap_cube(
    data_cube = insect_data,
    fun = b3gbi::pielou_evenness_ts,
    grouping_var = "year",
    samples = 1000,
    seed = 123,
    progress = TRUE)
  saveRDS(bootstrap_insect_evenness, insect_evenness_path)
}
```

```r
bootstrap_insect_data <- bootstrap_cube(
  data_cube = insect_data,
  fun = b3gbi::pielou_evenness_ts,
  grouping_var = "year",
  samples = 1000,
  seed = 123,
  progress = TRUE)
```

We visualise the distribution of the bootstrap replicates
The bootstrap bias is the difference between the estimate and the bootstrap estimate.

```{r, fig.width = 10, echo=FALSE, warning=FALSE}
bias_df <- bootstrap_insect_evenness %>%
  distinct(year, estimate = est_original, `bootstrap estimate` = est_boot)

estimate_df <- bias_df %>%
  pivot_longer(cols = c("estimate", "bootstrap estimate"),
               names_to = "Legend", values_to = "value") %>%
  mutate(Legend = factor(Legend, levels = c("estimate", "bootstrap estimate"),
                         ordered = TRUE))

bootstrap_insect_evenness %>%
  ggplot(aes(x = year)) +
    geom_violin(aes(y = rep_boot, group = year),
                fill = alpha("cornflowerblue", 0.2)) +
    geom_segment(data = bias_df,
                 aes(xend = year, y = estimate, yend = `bootstrap estimate`),
                 colour = "cornflowerblue", linewidth = 1) +
    geom_point(data = estimate_df, aes(y = value, shape = Legend),
               colour = "firebrick", size = 2) +
    labs(x = "", y = "Pielou's Eveness", shape = "Legend:") +
    scale_y_continuous(limits = c(0, 1), breaks = seq(-10, 10, 0.25)) +
    scale_x_continuous(breaks = sort(unique(bootstrap_insect_evenness$year))) +
    theme_minimal() +
    theme(legend.position = "bottom")
```

We calculate all types of intervals.

```{r, echo=FALSE, message=FALSE}
# Bootstrapping
ci_insect_eveness_path <- file.path(cache_path, "ci_df.Rds")
if (file.exists(ci_insect_eveness_path)) {
  ci_insect_eveness <- readRDS(ci_insect_eveness_path)
} else {
  # Calculate confidence intervals
  ci_insect_eveness <- get_bootstrap_ci(
    bootstrap_samples_df = bootstrap_insect_evenness,
    grouping_var = "year",
    type = c("perc", "bca", "norm", "basic"),
    conf = 0.95,
    aggregate = TRUE,
    data_cube = insect_data,
    fun = b3gbi::pielou_evenness_ts,
    progress = TRUE)
  saveRDS(ci_insect_eveness, ci_insect_eveness_path)
}
```

```r
ci_insect_eveness <- get_bootstrap_ci(
  bootstrap_samples_df = bootstrap_insect_evenness,
  grouping_var = "year",
  type = c("perc", "bca", "norm", "basic"),
  conf = 0.95,
  aggregate = TRUE,
  data_cube = insect_data,
  fun = b3gbi::pielou_evenness_ts,
  progress = TRUE)
```

# Analysis and visualisation

We visualise the distribution of the bootstrap replicates and the confidence intervals.

```{r, fig.width = 10, echo=FALSE, warning=FALSE}
p <- bootstrap_insect_data %>%
  ggplot(aes(x = year)) +
    geom_violin(aes(y = rep_boot, group = year),
                fill = alpha("cornflowerblue", 0.2)) +
    geom_point(data = estimate_df, aes(y = value, shape = Legend),
               colour = "firebrick", size = 2, alpha = 0.5) +
    geom_errorbar(data = ci_insect_eveness, aes(ymin = ll, ymax = ul, colour = int_type),
                  position = position_dodge(0.8), linewidth = 1) +
    labs(y = "evenness", colour = "Interval type:", x = "",
         shape = "Legend:") +
    scale_y_continuous(limits = c(NA, 1), breaks = seq(-10, 10, 0.25)) +
    scale_x_continuous(breaks = sort(unique(bootstrap_insect_data$year))) +
    theme_minimal() +
    theme(legend.position = "bottom")
p
```

The interval width increases when the bootstrap standard error increases, as expected.

```{r, echo=FALSE}
ci_insect_eveness %>%
  mutate(ci_width = ul - ll) %>%
  distinct(year, se_boot, int_type, ci_width) %>%
  ggplot(aes(x = se_boot, y = ci_width, colour = int_type)) +
    geom_point() +
    geom_smooth(method = "lm", formula = "y ~ x") +
    labs(x = "bootstrap standard error", y = "interval width",
         colour = "Confidence\ninterval")
```

```{r, echo=FALSE}
ci_insect_eveness %>%
  mutate(ci_width = ul - ll) %>%
  distinct(year, se_boot, int_type, ci_width) %>%
  group_by(int_type) %>%
  group_modify(~ grouped_regression(df = ., formula = ci_width ~ se_boot)) %>%
  ungroup() %>%
  filter(param == "se_boot") %>%
  kable()
```

We see no clear relation to bias.

```{r, echo=FALSE}
ci_insect_eveness %>%
  mutate(ci_width = ul - ll) %>%
  distinct(year, bias_boot, int_type, ci_width) %>%
  ggplot(aes(x = bias_boot, y = ci_width, colour = int_type)) +
    geom_point() +
    geom_smooth(method = "lm", formula = "y ~ x") +
    labs(x = "bootstrap bias", y = "interval width",
         colour = "Confidence\ninterval")
```

```{r, echo=FALSE}
ci_insect_eveness %>%
  mutate(ci_width = ul - ll) %>%
  distinct(year, bias_boot, int_type, ci_width) %>%
  group_by(int_type) %>%
  group_modify(~ grouped_regression(df = ., formula = ci_width ~ bias_boot)) %>%
  ungroup() %>%
  filter(param == "bias_boot") %>%
  kable()
```