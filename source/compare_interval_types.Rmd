---
title: "Interval type comparison"
author: "Ward Langeraert"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: show
    toc: true
    toc_float: true
    toc_collapsed: true
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../output/reports") })
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, warning=FALSE, message=FALSE}
# Load packages
library(b3gbi)       # Biodiversity indicators for data cubes
library(tidyverse)   # Data wrangling and visualisation
library(here)        # Relative paths
library(knitr)       # Nice tables

# Source functions
source(here("source", "R", "bootstrap_cube.R"))
source(here("source", "R", "get_bootstrap_ci.R"))
source(here("source", "R", "utils.R"))

# Cache folder
cache_path <- here("data", "cache")
dir.create(cache_path, showWarnings = FALSE, recursive = TRUE)
out_path <- here("output", "figures", "compare_interval_types")
dir.create(out_path, showWarnings = FALSE, recursive = TRUE)
```

# Goal

Compare confidence interval types for different indicators.

# Data

We install b3gbi package version 0.2.2.

## Dataset

We load a dataset from the package.
How does the cube look like?

```{r}
# Load GBIF data cube
cube_name <- system.file("extdata", "europe_insect_cube.csv", package = "b3gbi")

# Load taxonomic info for cube
tax_info <- system.file("extdata", "europe_insect_info.csv", package = "b3gbi")

insect_data_df <- read.csv(cube_name)
head(insect_data_df)
```

We process the cube.

```{r}
# Prepare cube
insect_data <- process_cube_old(cube_name, tax_info, first_year = 2011,
                                last_year = 2020)

insect_data
```

## Indicators

We choose 3 indicators for comparison:

1.  Mean Number of Observations per Grid Cell: real positive
2.  Pielou's Evenness (`obs_richness_ts()`): real between 0-1
3.  Observed Species Richness (`obs_richness_ts()`): positive integer

**1. Mean Number of Observations per Grid Cell**

```{r}
# Define function for calculating statistic
mean_obs <- function(data) {
  require("dplyr")
  require("rlang")

  data %>%
    mutate(x = mean(.data$obs), .by = .data$cellCode) %>%
    summarise(diversity_val = mean(.data$x), .by = .data$year) %>%
    as.data.frame()
}
```

Let's calculate the Mean Number of Observations over time.

```{r}
mean_obs_insect_data <- mean_obs(insect_data$data)
mean_obs_insect_data %>%
  kable(digits = 3)
```

```{r}
mean_obs_insect_data %>%
  ggplot(aes(x = year, y = diversity_val)) +
    geom_smooth(method = "loess", formula = "y ~ x", se = TRUE,
                colour = alpha("cornflowerblue", 0.8),
                fill = alpha("cornflowerblue", 0.1), linetype = "dashed") +
    geom_line(colour = "orange", linewidth = 1) +
    theme_minimal() +
    labs(x = "Year", y = "Mean Number of Observations\nper Grid Cell")
```

**2. Pielou's Evenness**

Let's calculate Pielou's Evenness over time.

```{r}
evenness_insect_data <- obs_richness_ts(insect_data)
evenness_insect_data$data %>%
  kable(digits = 3)
```

```{r}
plot(evenness_insect_data)
```

**3. Observed Species Richness**

Let's calculate the Observed Species Richness over time.

```{r}
richness_insect_data <- obs_richness_ts(insect_data)
richness_insect_data$data %>%
  kable()
```

```{r}
plot(richness_insect_data)
```

# Bootstrapping and interval calculation
## Mean Number of Observations per Grid Cell

Bootstrapping:

```{r, echo=FALSE, message=FALSE}
# Bootstrapping
insect_mean_obs_path <- file.path(cache_path, "bootstrap_insect_mean_obs.Rds")
if (file.exists(insect_mean_obs_path)) {
  bootstrap_insect_mean_obs <- readRDS(insect_mean_obs_path)
} else {
  bootstrap_insect_mean_obs <- bootstrap_cube(
    data_cube = insect_data$data,
    fun = mean_obs,
    grouping_var = "year",
    samples = 1000,
    seed = 123,
    progress = TRUE)
  saveRDS(bootstrap_insect_mean_obs, insect_mean_obs_path)
}
```

```r
bootstrap_insect_mean_obs <- bootstrap_cube(
  data_cube = insect_data$data,
  fun = mean_obs,
  grouping_var = "year",
  samples = 1000,
  seed = 123,
  progress = TRUE)
```

We visualise the distribution of the bootstrap replicates
The bootstrap bias is the difference between the estimate and the bootstrap estimate.

```{r, fig.width = 10, echo=FALSE, warning=FALSE}
bias_mean_obs <- bootstrap_insect_mean_obs %>%
  distinct(year, estimate = est_original, `bootstrap estimate` = est_boot)

estimate_mean_obs <- bias_mean_obs %>%
  pivot_longer(cols = c("estimate", "bootstrap estimate"),
               names_to = "Legend", values_to = "value") %>%
  mutate(Legend = factor(Legend, levels = c("estimate", "bootstrap estimate"),
                         ordered = TRUE))

bootstrap_insect_mean_obs %>%
  ggplot(aes(x = year)) +
    geom_violin(aes(y = rep_boot, group = year),
                fill = alpha("cornflowerblue", 0.2)) +
    geom_segment(data = bias_mean_obs,
                 aes(xend = year, y = estimate, yend = `bootstrap estimate`),
                 colour = "darkblue", linewidth = 0.8, linetype = "dashed") +
    geom_point(data = estimate_mean_obs, aes(y = value, shape = Legend),
               colour = "firebrick", size = 2) +
    labs(x = "", y = "Mean Number of Observations\nper Grid Cell",
         shape = "Legend:") +
    scale_y_continuous(limits = c(0, NA)) +
    scale_x_continuous(breaks = sort(unique(bootstrap_insect_mean_obs$year))) +
    theme_minimal() +
    theme(legend.position = "bottom",
        legend.title = element_text(face = "bold"))
```

We calculate all types of intervals.

```{r, echo=FALSE, message=FALSE}
# Bootstrapping
ci_insect_mean_obs_path <- file.path(cache_path, "ci_insect_mean_obs.Rds")
if (file.exists(ci_insect_mean_obs_path)) {
  ci_insect_mean_obs <- readRDS(ci_insect_mean_obs_path)
} else {
  # Calculate confidence intervals
  ci_insect_mean_obs <- get_bootstrap_ci(
    bootstrap_samples_df = bootstrap_insect_mean_obs,
    grouping_var = "year",
    type = c("perc", "bca", "norm", "basic"),
    conf = 0.95,
    aggregate = TRUE,
    data_cube = insect_data$data,
    fun = mean_obs,
    progress = TRUE)
  saveRDS(ci_insect_mean_obs, ci_insect_mean_obs_path)
}
```

```r
ci_insect_mean_obs <- get_bootstrap_ci(
  bootstrap_samples_df = bootstrap_insect_mean_obs,
  grouping_var = "year",
  type = c("perc", "bca", "norm", "basic"),
  conf = 0.95,
  aggregate = TRUE,
  data_cube = insect_data$data,
  fun = mean_obs,
  progress = TRUE)
```

## Pielou's Evenness

Bootstrapping:

```{r, echo=FALSE, message=FALSE}
# Bootstrapping
insect_evenness_path <- file.path(cache_path, "bootstrap_insect_data.Rds")
if (file.exists(insect_evenness_path)) {
  bootstrap_insect_evenness <- readRDS(insect_evenness_path)
} else {
  bootstrap_insect_evenness <- bootstrap_cube(
    data_cube = insect_data,
    fun = b3gbi::obs_richness_ts,
    grouping_var = "year",
    samples = 1000,
    seed = 123,
    progress = TRUE)
  saveRDS(bootstrap_insect_evenness, insect_evenness_path)
}
```

```r
bootstrap_insect_evenness <- bootstrap_cube(
  data_cube = insect_data,
  fun = b3gbi::obs_richness_ts,
  grouping_var = "year",
  samples = 1000,
  seed = 123,
  progress = TRUE)
```

We visualise the distribution of the bootstrap replicates
The bootstrap bias is the difference between the estimate and the bootstrap estimate.

```{r, fig.width = 10, echo=FALSE, warning=FALSE}
bias_evenness <- bootstrap_insect_evenness %>%
  distinct(year, estimate = est_original, `bootstrap estimate` = est_boot)

estimate_evenness <- bias_evenness %>%
  pivot_longer(cols = c("estimate", "bootstrap estimate"),
               names_to = "Legend", values_to = "value") %>%
  mutate(Legend = factor(Legend, levels = c("estimate", "bootstrap estimate"),
                         ordered = TRUE))

bootstrap_insect_evenness %>%
  ggplot(aes(x = year)) +
    geom_violin(aes(y = rep_boot, group = year),
                fill = alpha("cornflowerblue", 0.2)) +
    geom_segment(data = bias_evenness,
                 aes(xend = year, y = estimate, yend = `bootstrap estimate`),
                 colour = "darkblue", linewidth = 0.8, linetype = "dashed") +
    geom_point(data = estimate_evenness, aes(y = value, shape = Legend),
               colour = "firebrick", size = 2) +
    labs(x = "", y = "Pielou's Evenness", shape = "Legend:") +
    scale_y_continuous(limits = c(0, 1), breaks = seq(-10, 10, 0.25)) +
    scale_x_continuous(breaks = sort(unique(bootstrap_insect_evenness$year))) +
    theme_minimal() +
    theme(legend.position = "bottom",
          legend.title = element_text(face = "bold"))
```

We calculate all types of intervals.

```{r, echo=FALSE, message=FALSE}
# Bootstrapping
ci_insect_evenness_path <- file.path(cache_path, "ci_df.Rds")
if (file.exists(ci_insect_evenness_path)) {
  ci_insect_evenness <- readRDS(ci_insect_evenness_path)
} else {
  # Calculate confidence intervals
  ci_insect_evenness <- get_bootstrap_ci(
    bootstrap_samples_df = bootstrap_insect_evenness,
    grouping_var = "year",
    type = c("perc", "bca", "norm", "basic"),
    conf = 0.95,
    aggregate = TRUE,
    data_cube = insect_data,
    fun = b3gbi::obs_richness_ts,
    progress = TRUE)
  saveRDS(ci_insect_evenness, ci_insect_evenness_path)
}
```

```r
ci_insect_evenness <- get_bootstrap_ci(
  bootstrap_samples_df = bootstrap_insect_evenness,
  grouping_var = "year",
  type = c("perc", "bca", "norm", "basic"),
  conf = 0.95,
  aggregate = TRUE,
  data_cube = insect_data,
  fun = b3gbi::obs_richness_ts,
  progress = TRUE)
```

## Observed Species Richness

Bootstrapping:

```{r, echo=FALSE, message=FALSE}
# Bootstrapping
insect_richness_path <- file.path(cache_path, "bootstrap_insect_richness.Rds")
if (file.exists(insect_richness_path)) {
  bootstrap_insect_richness <- readRDS(insect_richness_path)
} else {
  bootstrap_insect_richness <- bootstrap_cube(
    data_cube = insect_data,
    fun = b3gbi::obs_richness_ts,
    grouping_var = "year",
    samples = 1000,
    seed = 123,
    progress = TRUE)
  saveRDS(bootstrap_insect_richness, insect_richness_path)
}
```

```r
bootstrap_insect_richness <- bootstrap_cube(
  data_cube = insect_data,
  fun = b3gbi::obs_richness_ts,
  grouping_var = "year",
  samples = 1000,
  seed = 123,
  progress = TRUE)
```

We visualise the distribution of the bootstrap replicates
The bootstrap bias is the difference between the estimate and the bootstrap estimate.

```{r, fig.width = 10, echo=FALSE, warning=FALSE}
bias_richness <- bootstrap_insect_richness %>%
  distinct(year, estimate = est_original, `bootstrap estimate` = est_boot)

estimate_richness <- bias_richness %>%
  pivot_longer(cols = c("estimate", "bootstrap estimate"),
               names_to = "Legend", values_to = "value") %>%
  mutate(Legend = factor(Legend, levels = c("estimate", "bootstrap estimate"),
                         ordered = TRUE))

bootstrap_insect_richness %>%
  ggplot(aes(x = year)) +
    geom_violin(aes(y = rep_boot, group = year),
                fill = alpha("cornflowerblue", 0.2)) +
    geom_segment(data = bias_richness,
                 aes(xend = year, y = estimate, yend = `bootstrap estimate`),
                 colour = "darkblue", linewidth = 0.8, linetype = "dashed") +
    geom_point(data = estimate_richness, aes(y = value, shape = Legend),
               colour = "firebrick", size = 2) +
    labs(x = "", y = "Observed Species Richness", shape = "Legend:") +
    scale_y_continuous(limits = c(0, NA)) +
    scale_x_continuous(breaks = sort(unique(bootstrap_insect_richness$year))) +
    theme_minimal() +
    theme(legend.position = "bottom",
          legend.title = element_text(face = "bold"))
```

We calculate all types of intervals.

```{r, echo=FALSE, message=FALSE}
# Bootstrapping
ci_insect_richness_path <- file.path(cache_path, "ci_insect_richness.Rds")
if (file.exists(ci_insect_richness_path)) {
  ci_insect_richness <- readRDS(ci_insect_richness_path)
} else {
  # Calculate confidence intervals
  ci_insect_richness <- get_bootstrap_ci(
    bootstrap_samples_df = bootstrap_insect_richness,
    grouping_var = "year",
    type = c("perc", "bca", "norm", "basic"),
    conf = 0.95,
    aggregate = TRUE,
    data_cube = insect_data,
    fun = b3gbi::obs_richness_ts,
    progress = TRUE)
  saveRDS(ci_insect_richness, ci_insect_richness_path)
}
```

```r
ci_insect_richness <- get_bootstrap_ci(
  bootstrap_samples_df = bootstrap_insect_richness,
  grouping_var = "year",
  type = c("perc", "bca", "norm", "basic"),
  conf = 0.95,
  aggregate = TRUE,
  data_cube = insect_data,
  fun = b3gbi::obs_richness_ts,
  progress = TRUE)
```

# Analysis and visualisation

```{r}
ci_insect_mean_obs <- ci_insect_mean_obs %>%
  mutate(int_type = factor(int_type,
                           levels = c("norm", "basic", "perc", "bca")))

ci_insect_evenness <- ci_insect_evenness %>%
  mutate(int_type = factor(int_type,
                           levels = c("norm", "basic", "perc", "bca")))
ci_insect_richness <- ci_insect_richness %>%
  mutate(int_type = factor(int_type,
                           levels = c("norm", "basic", "perc", "bca"))) %>%
  drop_na()
```

We visualise the distribution of the bootstrap replicates and the confidence intervals.

```{r}
my_theme <- theme_minimal() +
    theme(
      axis.text = element_text(size = 12),
      axis.title = element_text(size = 15)
    ) +
    theme(
      legend.position = "bottom",
      legend.title = element_text(face = "bold", size = 12),
      legend.text = element_text(size = 12)
      )
```

```{r, fig.width = 10, echo=FALSE, warning=FALSE}
p_ci_mean_obs <- bootstrap_insect_mean_obs %>%
  ggplot(aes(x = year)) +
    geom_violin(aes(y = rep_boot, group = year),
                fill = alpha("cornflowerblue", 0.2)) +
    geom_point(data = estimate_mean_obs, aes(y = value, shape = Legend),
               colour = "firebrick", size = 2, alpha = 0.5) +
    geom_errorbar(data = ci_insect_mean_obs,
                  aes(ymin = ll, ymax = ul, colour = int_type),
                  position = position_dodge(0.8), linewidth = 0.8) +
    labs(y = "Mean Number of Observations\nper Grid Cell",
         colour = "Interval type:", x = "", shape = "Legend:") +
    scale_y_continuous(limits = c(0, NA)) +
    scale_x_continuous(breaks = sort(unique(bootstrap_insect_mean_obs$year))) +
    my_theme
p_ci_mean_obs
```

```{r, fig.width = 10, echo=FALSE, warning=FALSE}
p_ci_evenness <- bootstrap_insect_evenness %>%
  ggplot(aes(x = year)) +
    geom_violin(aes(y = rep_boot, group = year),
                fill = alpha("cornflowerblue", 0.2)) +
    geom_point(data = estimate_evenness, aes(y = value, shape = Legend),
               colour = "firebrick", size = 2, alpha = 0.5) +
    geom_errorbar(data = ci_insect_evenness,
                  aes(ymin = ll, ymax = ul, colour = int_type),
                  position = position_dodge(0.8), linewidth = 0.8) +
    labs(y = "Pielou's Evenness", colour = "Interval type:", x = "",
         shape = "Legend:") +
    scale_y_continuous(limits = c(NA, 1), breaks = seq(-10, 10, 0.25)) +
    scale_x_continuous(breaks = sort(unique(bootstrap_insect_evenness$year))) +
    my_theme
p_ci_evenness
```

```{r, fig.width = 10, echo=FALSE, warning=FALSE}
p_ci_richness <- bootstrap_insect_richness %>%
  ggplot(aes(x = year)) +
    geom_violin(aes(y = rep_boot, group = year),
                fill = alpha("cornflowerblue", 0.2)) +
    geom_point(data = estimate_richness, aes(y = value, shape = Legend),
               colour = "firebrick", size = 2, alpha = 0.5) +
    geom_errorbar(data = ci_insect_richness,
                  aes(ymin = ll, ymax = ul, colour = int_type),
                  position = position_dodge(0.8), linewidth = 0.8,
                  width = 0.5) +
    labs(y = "Observed Species Richness", colour = "Interval type:", x = "",
         shape = "Legend:") +
    scale_y_continuous(limits = c(0, NA)) +
    scale_x_continuous(breaks = sort(unique(bootstrap_insect_richness$year))) +
    my_theme
p_ci_richness
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
ggsave(
  filename = file.path(out_path, "compare_ci_mean_obs.png"),
  plot = p_ci_mean_obs,
  dpi = 300,
  width = 10,
  height = 5)

ggsave(
  filename = file.path(out_path, "compare_ci_evenness.png"),
  plot = p_ci_evenness,
  dpi = 300,
  width = 10,
  height = 5)

ggsave(
  filename = file.path(out_path, "compare_ci_richness.png"),
  plot = p_ci_richness,
  dpi = 300,
  width = 10,
  height = 5)
```

The interval width increases when the bootstrap standard error increases, as expected.

```{r}
ci_insect_evenness %>%
    mutate(indicator = "Pielou's Evenness") %>%
    bind_rows(
        ci_insect_richness %>%
            mutate(indicator = "Observed Species Richness"),
        ci_insect_mean_obs %>%
            mutate(indicator = "Mean Number of Observations\nper Grid Cell")
    ) %>%
    mutate(ci_width = ul - ll,
           indicator = factor(
             indicator,
             levels = c("Mean Number of Observations\nper Grid Cell",
                        "Pielou's Evenness",
                        "Observed Species Richness"
                        )
             )
    ) %>%
    distinct(year, se_boot, indicator) %>%
    ggplot(aes(x = indicator, y = se_boot)) +
    geom_boxplot(fill = alpha("cornflowerblue", 0.2),
                 outlier.colour = "firebrick") +
    geom_jitter(size = 1.5, width = 0.2) +
    labs(y = "Bootstrap Standard Error", x = "") +
    facet_wrap(~indicator, ncol = 3, scales = "free") +
    theme_minimal()
```

```{r, echo=FALSE, warning=FALSE}
ci_insect_evenness %>%
  mutate(indicator = "Pielou's Evenness") %>%
  bind_rows(
    ci_insect_richness %>%
      mutate(indicator = "Observed Species Richness"),
    ci_insect_mean_obs %>%
      mutate(indicator = "Mean Number of Observations\nper Grid Cell")
  ) %>%
  mutate(ci_width = ul - ll,
           indicator = factor(
             indicator,
             levels = c("Mean Number of Observations\nper Grid Cell",
                        "Pielou's Evenness",
                        "Observed Species Richness"
                        )
             )
  ) %>%
  distinct(year, se_boot, int_type, ci_width, indicator) %>%
  ggplot(aes(x = se_boot, y = ci_width, colour = int_type)) +
    geom_smooth(method = "lm", formula = "y ~ x") +
    geom_point(size = 1.5) +
    labs(x = "Bootstrap Standard Error", y = "Interval Width",
         colour = "Interval type") +
    facet_wrap(~indicator, ncol = 2, scales = "free") +
    theme_minimal() +
    theme(
      legend.title = element_text(face = "bold"),
      legend.position = c(1, 0),
      legend.justification = c(2, -0.25)
    )
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
ci_insect_evenness %>%
  mutate(indicator = "Pielou's Evenness") %>%
  bind_rows(
    ci_insect_richness %>%
      mutate(indicator = "Observed Species Richness"),
    ci_insect_mean_obs %>%
      mutate(indicator = "Mean Number of Observations")
  ) %>%
  mutate(ci_width = ul - ll,
         indicator = factor(
           indicator,
           levels = c("Mean Number of Observations",
                      "Pielou's Evenness",
                      "Observed Species Richness"
                      )
           )
  ) %>%
  distinct(year, se_boot, int_type, ci_width, indicator) %>%
  group_by(int_type, indicator) %>%
  group_modify(~ grouped_regression(df = ., formula = ci_width ~ se_boot)) %>%
  ungroup() %>%
  filter(param == "se_boot") %>%
  arrange(int_type, indicator) %>%
  kable(digits = 5)
```

We see no relation to bias for evenness.
For species richness there is a negative relationship.

```{r}
ci_insect_evenness %>%
    mutate(indicator = "Pielou's Evenness") %>%
    bind_rows(
        ci_insect_richness %>%
            mutate(indicator = "Observed Species Richness"),
        ci_insect_mean_obs %>%
            mutate(indicator = "Mean Number of Observations\nper Grid Cell")
    ) %>%
    mutate(ci_width = ul - ll,
           indicator = factor(
             indicator,
             levels = c("Mean Number of Observations\nper Grid Cell",
                        "Pielou's Evenness",
                        "Observed Species Richness"
                        )
             )
    ) %>%
    distinct(year, bias_boot, indicator) %>%
    ggplot(aes(x = indicator, y = bias_boot)) +
    geom_boxplot(fill = alpha("cornflowerblue", 0.2),
                 outlier.colour = "firebrick") +
    geom_jitter(size = 1.5, width = 0.2) +
    labs(y = "Bootstrap Bias", x = "") +
    facet_wrap(~indicator, ncol = 3, scales = "free") +
    theme_minimal()
```

```{r, echo=FALSE, warning=FALSE}
ci_insect_evenness %>%
  mutate(indicator = "Pielou's Evenness") %>%
  bind_rows(
    ci_insect_richness %>%
      mutate(indicator = "Observed Species Richness"),
    ci_insect_mean_obs %>%
      mutate(indicator = "Mean Number of Observations\nper Grid Cell")
  ) %>%
  mutate(ci_width = ul - ll,
         indicator = factor(
           indicator,
           levels = c("Mean Number of Observations\nper Grid Cell",
                      "Pielou's Evenness",
                      "Observed Species Richness"
                      )
           )
  ) %>%
  distinct(year, bias_boot, int_type, ci_width, indicator) %>%
  mutate(abs_bias = abs(bias_boot)) %>%
  ggplot(aes(x = abs_bias, y = ci_width, colour = int_type)) +
    geom_smooth(method = "lm", formula = "y ~ x") +
    geom_point(size = 1.5) +
    labs(x = "Bootstrap Bias (absolute value)", y = "Interval Width",
         colour = "Interval type") +
    facet_wrap(~indicator, ncol = 2, scales = "free") +
    theme_minimal() +
    theme(
      legend.title = element_text(face = "bold"),
      legend.position = c(1, 0),
      legend.justification = c(2, -0.25)
    )
```

```{r, echo=FALSE}
ci_insect_evenness %>%
  mutate(indicator = "Pielou's Evenness") %>%
  bind_rows(
    ci_insect_richness %>%
      mutate(indicator = "Observed Species Richness"),
    ci_insect_mean_obs %>%
      mutate(indicator = "Mean Number of Observations")
  ) %>%
  mutate(ci_width = ul - ll,
         indicator = factor(
           indicator,
           levels = c("Mean Number of Observations",
                      "Pielou's Evenness",
                      "Observed Species Richness"
                      )
           )
  ) %>%
  distinct(year, bias_boot, int_type, ci_width, indicator) %>%
  mutate(abs_bias = abs(bias_boot)) %>%
  group_by(int_type, indicator) %>%
  group_modify(~ grouped_regression(df = ., formula = ci_width ~ abs_bias)) %>%
  ungroup() %>%
  filter(param == "abs_bias") %>%
  arrange(int_type, indicator) %>%
  kable(digits = 5)
```

If we remove the outliers for mean number of observations, we do not see a trend there as well.

```{r, echo=FALSE, warning=FALSE}
ci_insect_evenness %>%
  mutate(indicator = "Pielou's Evenness") %>%
  bind_rows(
    ci_insect_richness %>%
      mutate(indicator = "Observed Species Richness"),
    ci_insect_mean_obs %>%
      mutate(indicator = "Mean Number of Observations\nper Grid Cell")
  ) %>%
  mutate(ci_width = ul - ll,
         indicator = factor(
           indicator,
           levels = c("Mean Number of Observations\nper Grid Cell",
                      "Pielou's Evenness",
                      "Observed Species Richness"
                      )
           )
  ) %>%
  distinct(year, bias_boot, int_type, ci_width, indicator) %>%
  mutate(abs_bias = abs(bias_boot)) %>%
  filter(!(indicator == "Mean Number of Observations" & bias_boot > 2)) %>%
  ggplot(aes(x = abs_bias, y = ci_width, colour = int_type)) +
    geom_smooth(method = "lm", formula = "y ~ x") +
    geom_point(size = 1.5) +
    labs(x = "Bootstrap Bias (absolute value)", y = "Interval Width",
         colour = "Interval type") +
    facet_wrap(~indicator, ncol = 2, scales = "free") +
    theme_minimal() +
    theme(
      legend.title = element_text(face = "bold"),
      legend.position = c(1, 0),
      legend.justification = c(2, -0.25)
    )
```

```{r, echo=FALSE}
ci_insect_evenness %>%
  mutate(indicator = "Pielou's Evenness") %>%
  bind_rows(
    ci_insect_richness %>%
      mutate(indicator = "Observed Species Richness"),
    ci_insect_mean_obs %>%
      mutate(indicator = "Mean Number of Observations")
  ) %>%
  mutate(ci_width = ul - ll,
         indicator = factor(
           indicator,
           levels = c("Mean Number of Observations",
                      "Pielou's Evenness",
                      "Observed Species Richness"
                      )
           )
  ) %>%
  distinct(year, bias_boot, int_type, ci_width, indicator) %>%
  mutate(abs_bias = abs(bias_boot)) %>%
  filter(!(indicator == "Mean Number of Observations" & bias_boot > 2)) %>%
  group_by(int_type, indicator) %>%
  group_modify(~ grouped_regression(df = ., formula = ci_width ~ abs_bias)) %>%
  ungroup() %>%
  filter(param == "abs_bias") %>%
  arrange(int_type, indicator) %>%
  kable(digits = 5)
```

# Bootstrapping Species Richness

We could not use bootstrapping for Observed Species Richness.
There are however other techniques to estimate Species Richness that could be used:
https://vegandevs.github.io/vegan/reference/specpool.html

Do we get different results?

The incidence-based estimates use the frequencies of species in a collection of sites.
$S_P$ is the extrapolated richness in a pool, $S_0$ is the observed number of species in the collection, $a_1$ and $a_2$ are the number of species occurring only in one or only in two sites in the collection, $p_i$ is the frequency of species $i$, and $N$ is the number of sites in the collection.

Chao:

$$
S_P = S_0 + \frac{a_1^2}{2 a_2}\frac{N-1}{N}
$$

Chao bias-corrected:

$$
S_P = S_0 + \frac{a_1(a_1-1)}{2(a_2+1)} \frac{N-1}{N}
$$

First order jackknife:

$$
S_P = S_0 + a_1 \frac{N-1}{N}
$$


Second order jackknife:

$$
S_P = S_0 + a_1 \frac{2N - 3}{N} - a_2 \frac{(N-2)^2}{N (N-1)}
$$

Bootstrap:

$$
S_P = S_0 + \sum_{i=1}^{S_0} (1 - p_i)^N
$$

```{r}
incidence_estimator <- function(data, index) {
  require("dplyr")
  require("rlang")

  a1_df <- data %>%
    count(.data$taxonKey, .data$year) %>%
    filter(n == 1) %>%
    count(n, .data$year, name = "a1") %>%
    select(-n)
  a2_df <- data %>%
    count(.data$taxonKey, .data$year) %>%
    filter(n == 2) %>%
    count(n, .data$year, name = "a2") %>%
    select(-"n")

  summary_df <- data %>%
    summarise(
      s0 = n_distinct(.data$taxonKey),
      N = n_distinct(.data$cellCode),
      .by = .data$year) %>%
    left_join(a1_df, by = join_by(.data$year)) %>%
    left_join(a2_df, by = join_by(.data$year))

  if (index == "chao") {
    out_df <- summary_df %>%
      mutate(
        diversity_val = ifelse(.data$a2 == 0,
          .data$s0 + ((.data$a1 * (.data$a1 - 1)) / (2 * (.data$a2 + 1))) +
            ((.data$N - 1) / .data$N),
          .data$s0 + (.data$a1^2 / (2 * .data$a2)) + ((.data$N - 1) / .data$N)
          )
        ) %>%
      select("year", "diversity_val")

  } else if (index == "jack1") {
    out_df <- summary_df %>%
      mutate(
        diversity_val = .data$s0 + (.data$a1 * ((.data$N - 1) / .data$N))
        ) %>%
      select("year", "diversity_val")

  } else if (index == "jack2") {
    out_df <- summary_df %>%
      mutate(
        a1_part = .data$a1 * (((2 * .data$N) - 3) / .data$N),
        a2_part = .data$a2 * ((.data$N - 2)^2 / (.data$N * (.data$N - 1))),
        diversity_val = .data$s0 + .data$a1_part - .data$a2_part
        ) %>%
      select("year", "diversity_val")

  } else if (index == "boot") {
    p_df <- data %>%
      mutate(N = n_distinct(.data$cellCode),
             .by = .data$year) %>%
      count(.data$taxonKey, .data$year, .data$N) %>%
      mutate(p = .data$n / .data$N,
             calc = (1 - .data$p)^.data$N) %>%
      summarise(
        sum_of_calc = sum(.data$calc),
        .by = .data$year
      )

    out_df <- summary_df %>%
      left_join(p_df, by = join_by(.data$year)) %>%
      mutate(
        diversity_val = .data$s0 + .data$sum_of_calc
      ) %>%
      select("year", "diversity_val")

  } else {
    stop("`index` must be one of 'chao', 'jack1'', 'jack2', 'boot'")
  }

  return(out_df)
}
```

## Bootstrapping and Interval Calculation

Bootstrapping.

```{r, echo=FALSE, message=FALSE}
# Bootstrapping
insect_chao_path <- file.path(cache_path, "bootstrap_insect_chao.Rds")
if (file.exists(insect_chao_path)) {
  bootstrap_insect_chao <- readRDS(insect_chao_path)
} else {
  bootstrap_insect_chao <- bootstrap_cube(
    data_cube = insect_data$data,
    fun = incidence_estimator,
    index = "chao",
    grouping_var = "year",
    samples = 1000,
    seed = 123,
    progress = TRUE)
  saveRDS(bootstrap_insect_chao, insect_chao_path)
}
```

```r
bootstrap_insect_chao <- bootstrap_cube(
  data_cube = insect_data$data,
  fun = incidence_estimator,
  index = "chao",
  grouping_var = "year",
  samples = 1000,
  seed = 123,
  progress = TRUE)
```

```{r, echo=FALSE, message=FALSE}
# Bootstrapping
insect_jack1_path <- file.path(cache_path, "bootstrap_insect_jack1.Rds")
if (file.exists(insect_jack1_path)) {
  bootstrap_insect_jack1 <- readRDS(insect_jack1_path)
} else {
  bootstrap_insect_jack1 <- bootstrap_cube(
    data_cube = insect_data$data,
    fun = incidence_estimator,
    index = "jack1",
    grouping_var = "year",
    samples = 1000,
    seed = 123,
    progress = TRUE)
  saveRDS(bootstrap_insect_jack1, insect_jack1_path)
}
```

```r
bootstrap_insect_jack1 <- bootstrap_cube(
  data_cube = insect_data$data,
  fun = incidence_estimator,
  index = "jack1",
  grouping_var = "year",
  samples = 1000,
  seed = 123,
  progress = TRUE)
```

```{r, echo=FALSE, message=FALSE}
# Bootstrapping
insect_jack2_path <- file.path(cache_path, "bootstrap_insect_jack2.Rds")
if (file.exists(insect_jack2_path)) {
  bootstrap_insect_jack2 <- readRDS(insect_jack2_path)
} else {
  bootstrap_insect_jack2 <- bootstrap_cube(
    data_cube = insect_data$data,
    fun = incidence_estimator,
    index = "jack2",
    grouping_var = "year",
    samples = 1000,
    seed = 123,
    progress = TRUE)
  saveRDS(bootstrap_insect_jack2, insect_jack2_path)
}
```

```r
bootstrap_insect_jack2 <- bootstrap_cube(
  data_cube = insect_data$data,
  fun = incidence_estimator,
  index = "jack2",
  grouping_var = "year",
  samples = 1000,
  seed = 123,
  progress = TRUE)
```

```{r, echo=FALSE, message=FALSE}
# Bootstrapping
insect_boot_path <- file.path(cache_path, "bootstrap_insect_boot.Rds")
if (file.exists(insect_boot_path)) {
  bootstrap_insect_boot <- readRDS(insect_boot_path)
} else {
  bootstrap_insect_boot <- bootstrap_cube(
    data_cube = insect_data$data,
    fun = incidence_estimator,
    index = "boot",
    grouping_var = "year",
    samples = 1000,
    seed = 123,
    progress = TRUE)
  saveRDS(bootstrap_insect_boot, insect_boot_path)
}
```

```r
bootstrap_insect_boot <- bootstrap_cube(
  data_cube = insect_data$data,
  fun = incidence_estimator,
  index = "boot",
  grouping_var = "year",
  samples = 1000,
  seed = 123,
  progress = TRUE)
```

We calculate all types of intervals.

```{r, echo=FALSE, message=FALSE}
# Bootstrapping
ci_insect_chao_path <- file.path(cache_path, "ci_insect_chao.Rds")
if (file.exists(ci_insect_chao_path)) {
  ci_insect_chao <- readRDS(ci_insect_chao_path)
} else {
  # Calculate confidence intervals
  ci_insect_chao <- get_bootstrap_ci(
    bootstrap_samples_df = bootstrap_insect_chao,
    grouping_var = "year",
    type = c("perc", "bca", "norm", "basic"),
    conf = 0.95,
    aggregate = TRUE,
    data_cube = insect_data$data,
    fun = incidence_estimator,
    index = "chao",
    progress = TRUE)
  saveRDS(ci_insect_chao, ci_insect_chao_path)
}
```

```r
ci_insect_chao <- get_bootstrap_ci(
  bootstrap_samples_df = bootstrap_insect_chao,
  grouping_var = "year",
  type = c("perc", "bca", "norm", "basic"),
  conf = 0.95,
  aggregate = TRUE,
  data_cube = insect_data$data,
  fun = incidence_estimator,
  index = "chao",
  progress = TRUE)
```

```{r, echo=FALSE, message=FALSE}
# Bootstrapping
ci_insect_jack1_path <- file.path(cache_path, "ci_insect_jack1.Rds")
if (file.exists(ci_insect_jack1_path)) {
  ci_insect_jack1 <- readRDS(ci_insect_jack1_path)
} else {
  # Calculate confidence intervals
  ci_insect_jack1 <- get_bootstrap_ci(
    bootstrap_samples_df = bootstrap_insect_jack1,
    grouping_var = "year",
    type = c("perc", "bca", "norm", "basic"),
    conf = 0.95,
    aggregate = TRUE,
    data_cube = insect_data$data,
    fun = incidence_estimator,
    index = "jack1",
    progress = TRUE)
  saveRDS(ci_insect_jack1, ci_insect_jack1_path)
}
```

```r
ci_insect_jack1 <- get_bootstrap_ci(
  bootstrap_samples_df = bootstrap_insect_jack1,
  grouping_var = "year",
  type = c("perc", "bca", "norm", "basic"),
  conf = 0.95,
  aggregate = TRUE,
  data_cube = insect_data$data,
  fun = incidence_estimator,
  index = "jack1",
  progress = TRUE)
```

```{r, echo=FALSE, message=FALSE}
# Bootstrapping
ci_insect_jack2_path <- file.path(cache_path, "ci_insect_jack2.Rds")
if (file.exists(ci_insect_jack2_path)) {
  ci_insect_jack2 <- readRDS(ci_insect_jack2_path)
} else {
  # Calculate confidence intervals
  ci_insect_jack2 <- get_bootstrap_ci(
    bootstrap_samples_df = bootstrap_insect_jack2,
    grouping_var = "year",
    type = c("perc", "bca", "norm", "basic"),
    conf = 0.95,
    aggregate = TRUE,
    data_cube = insect_data$data,
    fun = incidence_estimator,
    index = "jack2",
    progress = TRUE)
  saveRDS(ci_insect_jack2, ci_insect_jack2_path)
}
```

```r
ci_insect_jack2 <- get_bootstrap_ci(
  bootstrap_samples_df = bootstrap_insect_jack2,
  grouping_var = "year",
  type = c("perc", "bca", "norm", "basic"),
  conf = 0.95,
  aggregate = TRUE,
  data_cube = insect_data$data,
  fun = incidence_estimator,
  index = "jack2",
  progress = TRUE)
```

```{r, echo=FALSE, message=FALSE}
# Bootstrapping
ci_insect_boot_path <- file.path(cache_path, "ci_insect_boot.Rds")
if (file.exists(ci_insect_boot_path)) {
  ci_insect_boot <- readRDS(ci_insect_boot_path)
} else {
  # Calculate confidence intervals
  ci_insect_boot <- get_bootstrap_ci(
    bootstrap_samples_df = bootstrap_insect_boot,
    grouping_var = "year",
    type = c("perc", "bca", "norm", "basic"),
    conf = 0.95,
    aggregate = TRUE,
    data_cube = insect_data$data,
    fun = incidence_estimator,
    index = "boot",
    progress = TRUE)
  saveRDS(ci_insect_boot, ci_insect_boot_path)
}
```

```r
ci_insect_boot <- get_bootstrap_ci(
  bootstrap_samples_df = bootstrap_insect_boot,
  grouping_var = "year",
  type = c("perc", "bca", "norm", "basic"),
  conf = 0.95,
  aggregate = TRUE,
  data_cube = insect_data$data,
  fun = incidence_estimator,
  index = "boot",
  progress = TRUE)
```

```{r}
ci_insect_chao <- ci_insect_chao %>%
  mutate(int_type = factor(int_type,
                           levels = c("norm", "basic", "perc", "bca"))) %>%
  drop_na()

ci_insect_jack2 <- ci_insect_jack2 %>%
  mutate(int_type = factor(int_type,
                           levels = c("norm", "basic", "perc", "bca"))) %>%
  drop_na()
ci_insect_jack2 <- ci_insect_jack2 %>%
  mutate(int_type = factor(int_type,
                           levels = c("norm", "basic", "perc", "bca"))) %>%
  drop_na()
ci_insect_boot <- ci_insect_boot %>%
  mutate(int_type = factor(int_type,
                           levels = c("norm", "basic", "perc", "bca"))) %>%
  drop_na()
```

```{r}
bias_chao <- bootstrap_insect_chao %>%
  distinct(year, estimate = est_original, `bootstrap estimate` = est_boot)

estimate_chao <- bias_chao %>%
  pivot_longer(cols = c("estimate", "bootstrap estimate"),
               names_to = "Legend", values_to = "value") %>%
  mutate(Legend = factor(Legend, levels = c("estimate", "bootstrap estimate"),
                         ordered = TRUE))

bootstrap_insect_chao %>%
  ggplot(aes(x = year)) +
    geom_violin(aes(y = rep_boot, group = year),
                fill = alpha("cornflowerblue", 0.2)) +
    geom_point(data = estimate_chao, aes(y = value, shape = Legend),
               colour = "firebrick", size = 2, alpha = 0.5) +
    geom_errorbar(data = ci_insect_chao,
                  aes(ymin = ll, ymax = ul, colour = int_type),
                  position = position_dodge(0.8), linewidth = 0.8,
                  width = 0.5) +
    labs(y = "Observed Species Richness", colour = "Interval type:", x = "",
         shape = "Legend:") +
    scale_y_continuous(limits = c(0, NA)) +
    scale_x_continuous(breaks = sort(unique(bootstrap_insect_chao$year))) +
    my_theme
```

```{r}
bias_jack1 <- bootstrap_insect_jack1 %>%
  distinct(year, estimate = est_original, `bootstrap estimate` = est_boot)

estimate_jack1 <- bias_jack1 %>%
  pivot_longer(cols = c("estimate", "bootstrap estimate"),
               names_to = "Legend", values_to = "value") %>%
  mutate(Legend = factor(Legend, levels = c("estimate", "bootstrap estimate"),
                         ordered = TRUE))

bootstrap_insect_jack1 %>%
  ggplot(aes(x = year)) +
    geom_violin(aes(y = rep_boot, group = year),
                fill = alpha("cornflowerblue", 0.2)) +
    geom_point(data = estimate_jack1, aes(y = value, shape = Legend),
               colour = "firebrick", size = 2, alpha = 0.5) +
    geom_errorbar(data = ci_insect_jack1,
                  aes(ymin = ll, ymax = ul, colour = int_type),
                  position = position_dodge(0.8), linewidth = 0.8,
                  width = 0.5) +
    labs(y = "Observed Species Richness", colour = "Interval type:", x = "",
         shape = "Legend:") +
    scale_y_continuous(limits = c(0, NA)) +
    scale_x_continuous(breaks = sort(unique(bootstrap_insect_jack1$year))) +
    my_theme
```

```{r}
bias_jack2 <- bootstrap_insect_jack2 %>%
  distinct(year, estimate = est_original, `bootstrap estimate` = est_boot)

estimate_jack2 <- bias_jack2 %>%
  pivot_longer(cols = c("estimate", "bootstrap estimate"),
               names_to = "Legend", values_to = "value") %>%
  mutate(Legend = factor(Legend, levels = c("estimate", "bootstrap estimate"),
                         ordered = TRUE))

bootstrap_insect_jack2 %>%
  ggplot(aes(x = year)) +
    geom_violin(aes(y = rep_boot, group = year),
                fill = alpha("cornflowerblue", 0.2)) +
    geom_point(data = estimate_jack2, aes(y = value, shape = Legend),
               colour = "firebrick", size = 2, alpha = 0.5) +
    geom_errorbar(data = ci_insect_jack2,
                  aes(ymin = ll, ymax = ul, colour = int_type),
                  position = position_dodge(0.8), linewidth = 0.8,
                  width = 0.5) +
    labs(y = "Observed Species Richness", colour = "Interval type:", x = "",
         shape = "Legend:") +
    scale_y_continuous(limits = c(0, NA)) +
    scale_x_continuous(breaks = sort(unique(bootstrap_insect_jack2$year))) +
    my_theme
```

```{r}
bias_boot <- bootstrap_insect_boot %>%
  distinct(year, estimate = est_original, `bootstrap estimate` = est_boot)

estimate_boot <- bias_boot %>%
  pivot_longer(cols = c("estimate", "bootstrap estimate"),
               names_to = "Legend", values_to = "value") %>%
  mutate(Legend = factor(Legend, levels = c("estimate", "bootstrap estimate"),
                         ordered = TRUE))

bootstrap_insect_boot %>%
  ggplot(aes(x = year)) +
    geom_violin(aes(y = rep_boot, group = year),
                fill = alpha("cornflowerblue", 0.2)) +
    geom_point(data = estimate_boot, aes(y = value, shape = Legend),
               colour = "firebrick", size = 2, alpha = 0.5) +
    geom_errorbar(data = ci_insect_boot,
                  aes(ymin = ll, ymax = ul, colour = int_type),
                  position = position_dodge(0.8), linewidth = 0.8,
                  width = 0.5) +
    labs(y = "Observed Species Richness", colour = "Interval type:", x = "",
         shape = "Legend:") +
    scale_y_continuous(limits = c(0, NA)) +
    scale_x_continuous(breaks = sort(unique(bootstrap_insect_boot$year))) +
    my_theme
```

## Conclusion

We still have the same problem as before.
This is not possible with bootstrapping.
