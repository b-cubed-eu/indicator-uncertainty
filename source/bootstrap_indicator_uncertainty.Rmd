---
title: "Calculate biodiversity indicator uncertainty"
subtitle: "Bootstrapping"
author: "Ward Langeraert"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# Load packages
library(b3gbi)     # Biodiversity indicators for data cubes
library(tidyverse) # Data wrangling and visualisation
library(here)      # Relative paths

# Source functions
source(here("source", "R", "evenness_formula.R"))
source(here("source", "R", "boot_statistic.R"))
source(here("source", "R", "perform_bootstrap.R"))
source(here("source", "R", "bootstrap_list_to_df.R"))
source(here("source", "R", "get_bootstrap_ci.R"))
```

# Exploration of the b3gbi package

We install b3gbi package version 0.2.1.
We load a dataset from the package.
How does the cube look like?

```{r}
# Load GBIF data cube
cube_name <- system.file("extdata", "europe_insect_cube.csv", package = "b3gbi")

# Load taxonomic info for cube
tax_info <- system.file("extdata", "europe_insect_info.csv", package = "b3gbi")

insect_data_df <- read.csv(cube_name)
head(insect_data_df)
```

We process the cube.

```{r}
# Prepare cube
insect_data <- process_cube_old(cube_name, tax_info)

insect_data
```

> Where did the info on min. coordinate uncertainty in meters go?

```{r}
# Calculate diversity metric
map_obs_rich_insects <- obs_richness_map(insect_data)

print(map_obs_rich_insects)
```

```{r}
# Plot diversity metric
plot(map_obs_rich_insects,
     title = "Observed Species Richness: Insects in Europe")
```

## Calculate an index over time

Let's calculate Pietlou's eveness over time using b3gbi.

```{r}
eveness_insect_data <- pielou_evenness_ts(insect_data)
head(eveness_insect_data)
```

```{r}
plot(eveness_insect_data)
```

> Visualisation of trend not correct.

Let's calculate this metric from scratch.
We select the data after 2010 to ensure calculations with enough data.

```{r}
insect_data_new <- insect_data$data %>%
  group_by(year) %>%
  mutate(n = sum(obs)) %>%
  ungroup() %>%
  filter(year > 2010) %>%
  select(-n)

insect_data_new %>%
  group_by(year) %>%
  summarise(n_obs = sum(obs)) %>%
  ggplot() +
    geom_bar(aes(x = as.factor(year), y = n_obs), stat = "identity") +
    labs(x = "year", y = "number of observations")
```

## Bootstrapping

We calculate bootstrap replicates for evenness (`boot::boot()`).

```{r}
# Bootstrapping
bootstrap_insect_data <- perform_bootstrap(
  data_cube_df = insect_data_new,
  fun = evenness_formula,
  replicates = 1000,
  seed = 123)

# Summarise in dataframe
bootstrap_insect_data_full <- bootstrap_list_to_df(bootstrap_insect_data)
```

We get confidence intervals (`boot::boot.ci()`) and add it to the dataframe.

```{r}
# Calculate confidence intervals
ci_df <- get_bootstrap_ci(bootstrap_insect_data)

# Join dataframes
bootstrap_insect_data_final <- bootstrap_insect_data_full %>%
  full_join(ci_df, by = join_by(year), relationship = "many-to-many")
```

## Visualise confidence intervals

We visualise the distribution of the bootstrap replicates.
The red dots are the evenness measures based on all the data.

```{r}
bootstrap_insect_data_final %>%
  ggplot(aes(x = year)) +
    geom_boxplot(aes(y = original)) +
    geom_point(aes(y = stat_value), colour = "firebrick", size = 3) +
    labs(y = "evenness") +
    scale_y_continuous(limits = c(0, 1))
```

```{r}
bootstrap_insect_data_final %>%
  ggplot(aes(x = year)) +
    geom_violin(aes(y = original)) +
    geom_point(aes(y = stat_value), colour = "firebrick", size = 3) +
    labs(y = "evenness") +
    scale_y_continuous(limits = c(0, 1))
```

We visualise the confidence intervals.

```{r}
bootstrap_insect_data_final %>%
  distinct(year, stat_value, stat_se, conf_name, ll, ul, conf_level) %>%
  ggplot(aes(x = year, y = stat_value, group = conf_name)) +
    geom_errorbar(aes(ymin = ll, ymax = ul, colour = conf_name),
                  position = position_dodge(0.8), linewidth = 1) +
    geom_point(colour = "firebrick", size = 3, position = position_dodge(0.8)) +
    labs(y = "evenness") +
    scale_y_continuous(limits = c(NA, 1))
```

We compare the confidence intervals with the distribution of the bootstrap replicates.

```{r}
bootstrap_insect_data_final %>%
  ggplot(aes(x = year)) +
    geom_boxplot(aes(y = original)) +
    geom_errorbar(aes(ymin = ll, ymax = ul, colour = conf_name),
                  position = position_dodge(0.8), linewidth = 1) +
    geom_point(aes(y = stat_value), colour = "firebrick", size = 3) +
    scale_y_continuous(limits = c(NA, 1))
```

```{r}
bootstrap_insect_data_final %>%
  ggplot(aes(x = year)) +
    geom_violin(aes(y = original)) +
    geom_errorbar(aes(ymin = ll, ymax = ul, colour = conf_name),
                  position = position_dodge(0.8), linewidth = 1) +
    geom_point(aes(y = stat_value), colour = "firebrick", size = 3) +
    labs(y = "evenness") +
    scale_y_continuous(limits = c(NA, 1))
```
